---
title: Swift ç¶²è·¯å±¤ç”Ÿå­˜æŒ‡å—(2)
description: å»ºç«‹é–‹ç™¼åˆç´„ï¼šé€é BaseResponseProtocol æŠ½è±¡åŒ–å¤šæ¨£çš„ API çµæ§‹ï¼Œå„ªé›… Handle æ¥­å‹™éŒ¯èª¤èˆ‡è³‡æ–™ç½é›£ã€‚
date: 2026-01-10
slug: 2026-01-10
tags: ["AIå¯«ä½œ", "Networking", "BadBackend"]
categories: [Personal]
---

åœ¨å‰ä¸€ç¯‡[æ–‡ç« ](https://shinrenpan.github.io/2026-01-01/)ä¸­ï¼Œæˆ‘å€‘å­¸æœƒäº†å¦‚ä½•ä½¿ç”¨ `SafeBox` å’Œ `FlexibleResponse` ç¢ºä¿ App ä¸æœƒå› ç‚ºå¾Œç«¯çš„é«’è³‡æ–™è€Œé–ƒé€€ã€‚ä½†ã€Œä¸å´©æ½°ã€åªæ˜¯ç¬¬ä¸€æ­¥ã€‚åœ¨å¯¦å‹™é–‹ç™¼ä¸­ï¼Œæˆ‘å€‘é‚„éœ€è¦èƒ½**æ­£ç¢ºä¸”é«˜æ•ˆåœ°è™•ç†æ¥­å‹™é‚è¼¯éŒ¯èª¤**ï¼ˆå¦‚ï¼šå¯†ç¢¼éŒ¯èª¤ã€æ¬Šé™ä¸è¶³ï¼‰ã€‚

ä»Šå¤©æˆ‘å€‘è¦è¨è«–çš„æ˜¯å¦‚ä½•é€é **`BaseResponseProtocol`**ï¼Œåœ¨å¤šè®Šçš„å¾Œç«¯ç’°å¢ƒä¸­å»ºç«‹ä¸€å¥—çµ±ä¸€çš„ã€Œé–‹ç™¼åˆç´„ã€ã€‚

---

## ğŸ›ï¸ ç¬¬ä¸€æ­¥ï¼šèˆ‡ BadBackend è¨‚ç«‹å¤–æ®¼åˆç´„

å³ä¾¿åŠŸèƒ½ä¸€æ¨£ï¼Œä¸åŒå…¬å¸çš„å¾Œç«¯çµ¦ä½ çš„ã€Œå¤–æ®¼ã€å‘½åå¯èƒ½å¤©å·®åœ°é ã€‚å‡è¨­ä½ å»å¹´åœ¨ A å…¬å¸ï¼Œä»Šå¹´è·³æ§½åˆ°äº† B å…¬å¸ï¼Œé€™å…©é–“å…¬å¸é›–ç„¶å‘½åä¸åŒï¼Œä½†éƒ½é‚„ç®—ã€Œå®ˆç´„ã€ï¼ˆçµæ§‹ç©©å®šï¼‰ï¼š

### **å»å¹´åœ¨ A å…¬å¸ (åŒ…è£æ´¾)**
```json
{
  "statusCode": 200,
  "message": "success",
  "result": { "data": { "id": 1, "name": "iPhone 17" } }
}
```

### **ä»Šå¹´åœ¨ B å…¬å¸ (ç°¡ç´„æ´¾)**
```json
{
  "code": 200,
  "msg": "OK",
  "data": { "id": 1, "name": "iPhone 17" }
}
```

ç‚ºäº†æŠ¹å¹³å·®ç•°ï¼Œæˆ‘å€‘å®šç¾©ä¸€å€‹ Protocol æŠ½è±¡åŒ–é€™äº›å·®ç•°ï¼š

```swift
protocol BaseResponseProtocol: Decodable {
    associatedtype Payload: Codable
    var isSuccess: Bool { get }             // æ¥­å‹™æˆåŠŸèˆ‡å¦çš„çµ±ä¸€åˆ¤æ–·
    var message: String { get }             // éŒ¯èª¤è¨Šæ¯æ¬„ä½
    var result: FlexibleResponse<Payload> { get }
}
```

---

## ğŸ› ï¸ ç¬¬äºŒæ­¥ï¼šç‚º A / B å…¬å¸æ‰“é€ æ¨™æº–è½‰æ¥é ­

### **A å…¬å¸å¯¦ä½œ**
```swift
struct CompanyAResponse<T: Codable>: BaseResponseProtocol {
    @SafeBox var statusCode: Int
    @SafeBox var message: String
    let result: FlexibleResponse<T>

    var isSuccess: Bool { statusCode == 200 }
}
```

### **B å…¬å¸å¯¦ä½œ**
```swift
struct CompanyBResponse<T: Codable>: BaseResponseProtocol {
    @SafeBox var code: Int
    @SafeBox var msg: String
    let data: FlexibleResponse<T>

    var isSuccess: Bool { code == 200 }
    var message: String { msg }
    var result: FlexibleResponse<T> { data }
}
```

---

## ğŸï¸ ç¬¬ä¸‰æ­¥ï¼šæ¨™æº–åŒ– Request æµç¨‹

æœ‰äº†åˆç´„ï¼Œä½ çš„ `NetworkManager` å°±èƒ½å°ˆæ³¨æ–¼è™•ç†ã€Œæ¥­å‹™é‚è¼¯éŒ¯èª¤ã€ã€‚

```swift
func request<R: BaseResponseProtocol>(url: URL) async throws -> R.Payload {
    // 1. ä¸‹è¼‰æ•¸æ“š
    let (data, _) = try await URLSession.shared.data(from: url)

    // 2. è§£æå¤–æ®¼ (æ­¤æ™‚ SafeBox æœƒä¿è­· code/message çš„å‹åˆ¥)
    let response = try JSONDecoder().decode(R.self, from: data)

    // 3. æ­£ç¢ºä¸”é«˜æ•ˆåœ°è™•ç†æ¥­å‹™é‚è¼¯éŒ¯èª¤ (å¦‚ï¼šå¯†ç¢¼éŒ¯èª¤)
    guard response.isSuccess else {
        throw APIError.businessError(message: response.message)
    }

    // 4. è§£ææˆåŠŸï¼šå¾ FlexibleResponse æå–è³‡æ–™æˆå“
    return response.result.result
}
```

---

## ğŸš¨ é€²éšç‰¹ä¾‹ï¼šæ‡‰å°ã€Œæ¯€ç´„ã€çš„ C å…¬å¸

åœ¨ 90% çš„æƒ…æ³ä¸‹ï¼Œä¸Šè¿°æµç¨‹å·²ç¶“å®Œç¾ã€‚ä½†ç¾å¯¦ä¸­ç¸½æœ‰æœ€å£çš„æƒ…æ³ï¼š**ç‰¹ä¾‹ C** æœƒåœ¨å¤±æ•—æ™‚**æ¯€æ‰åŸå§‹çµæ§‹**ã€‚

### **ç‰¹ä¾‹ C çš„æ¯€ç´„ç¾å ´**

* **æˆåŠŸæ™‚ (å®ˆç´„)**ï¼šçµæ§‹å®Œæ•´ï¼Œæœ‰ `data`ã€‚
```json
{
  "statusCode": 200,
  "result": { "data": { "id": 99, "name": "ç‰¹è£½å•†å“" } }
}
```

* **å¤±æ•—æ™‚ (æ¯€ç´„)**ï¼š`data` æ¬„ä½ç›´æ¥æ¶ˆå¤±ï¼
```json
{
  "statusCode": 403,
  "result": { "message": "æ‚¨çš„å¸³è™Ÿæ¬Šé™ä¸è¶³" }
}
```

é€™æœƒå°è‡´ `JSONDecoder` åœ¨ Step 2 è§£æ `result` æ™‚å™´å‡º `keyNotFound`ã€‚æˆ‘å€‘å¿…é ˆå¼•å…¥ **`DefaultProvider`** æ•‘ç½ï¼š

```swift
struct CompanyCResponse<T: Codable>: BaseResponseProtocol {
  @SafeBox var statusCode: Int
  let result: FlexibleResponse<T>
  let message: String

  var isSuccess: Bool { statusCode == 200 }

  enum CodingKeys: String, CodingKey { case statusCode, result }
  enum ResultKeys: String, CodingKey { case data, message }

  init(from decoder: Decoder) throws {
    let container = try decoder.container(keyedBy: CodingKeys.self)
    let statusBox = try container.decode(SafeBox<Int>.self, forKey: .statusCode)
    let success = statusBox.wrappedValue == 200 // å±€éƒ¨åˆ¤æ–·é‚è¼¯

    if success {
      self.result = try container.decode(FlexibleResponse<T>.self, forKey: .result)
      self.message = "Success"
    } else {
      let resultContainer = try container.nestedContainer(keyedBy: ResultKeys.self, forKey: .result)
      self.message = try resultContainer.decodeIfPresent(String.self, forKey: .message) ?? "Error"
      self.result = FlexibleResponse(result: nil)
    }

    self._statusCode = statusBox
  }
}
```

---

## ğŸš¦ è§€å¿µé‡æ¸…ï¼šæ­£è¦ Error vs. è™•åˆ‘ Log

é€™å¥—æ¶æ§‹çš„æ ¸å¿ƒåœ¨æ–¼å€åˆ†ã€Œä»€éº¼è©²å ±éŒ¯ã€èˆ‡ã€Œä»€éº¼è©²æ•‘ç½ã€ï¼š

1.  **æ­£è¦æ¥­å‹™éŒ¯èª¤ (Business Error)**ï¼š
    * **ç‹€æ³**ï¼šAPI è§£ææˆåŠŸï¼Œä½† `isSuccess` ç‚º `false`ã€‚
    * **è™•ç†**ï¼šé€™æ˜¯æ­£è¦æºé€šï¼Œæˆ‘å€‘ `throw Error` è®“ UI é¡¯ç¤ºè¨Šæ¯ã€‚
2.  **è³‡æ–™æ•‘ç½è™•åˆ‘ (Execution Log)**ï¼š
    * **ç‹€æ³**ï¼šèªªå¥½æ˜¯æ•¸å­—å»çµ¦ `null`ï¼Œæˆ–èªªå¥½å« `data` å»æ”¹åã€‚
    * **è™•ç†**ï¼šé€™æ˜¯ä¸å®ˆä¿¡ç”¨ã€‚`SafeBox` æˆ– `FlexibleResponse` æœƒä¿®å¾©å®ƒä¸¦å™´å‡º **`[è™•åˆ‘ Log]`** ä¾›å·¥ç¨‹å¸«è¿½è¹¤ï¼Œä½†ä¸æ‡‰å¹²æ“¾ä½¿ç”¨è€…ã€‚

---

## ğŸ“‹ é™„éŒ„ï¼šBaseResponseProtocol çš„é‚Šç•Œèˆ‡ä»£åƒ¹

1.  **ã€Œåˆç´„ã€çš„è„†å¼±æ€§**ï¼šæ¶æ§‹å»ºç«‹åœ¨å¾Œç«¯ã€Œè‡³å°‘æœƒå›å‚³å¤–æ®¼ã€çš„å‰æä¸Šã€‚å¦‚æœå¾Œç«¯å£åˆ°é€£å¤–æ®¼éƒ½éš¨æ©Ÿæ¶ˆå¤±ï¼Œè§£æä»æœƒå¤±æ•—ã€‚
2.  **èªç¾©æ¨¡ç³ŠåŒ–**ï¼šç‚ºäº†çµ±ä¸€å„å®¶å…¬å¸ï¼Œæˆ‘å€‘è¢«è¿«å°‡éŒ¯èª¤æŠ½è±¡ç‚º `code` èˆ‡ `message`ã€‚
3.  **è§£ææè€—**ï¼šå¤šå±¤è§£ç¢¼èˆ‡å±¬æ€§è½‰æ¥æœƒæœ‰å¾®é‡æ€§èƒ½ä»£åƒ¹ï¼Œä½†åœ¨ 99% çš„å ´æ™¯ä¸­å¯å¿½ç•¥ä¸è¨ˆã€‚

---

## ğŸ’¡ ç¸½çµï¼šæ¶æ§‹å³æºé€šï¼ˆèˆ‡è‡ªä¿ï¼‰

é€™å¥—é€²éšæ¶æ§‹çš„æ ¸å¿ƒå“²å­¸ä¸åªæ˜¯**ã€Œåˆ†æ¸…è²¬ä»»ã€**ï¼Œæ›´æ˜¯ç‚ºäº†è®“ä½ åœ¨é€±äº”å‚æ™šèƒ½æº–æ™‚ä¸‹ç­ï¼š

* **å°å¤–ï¼ˆèˆ‡å…¬å¸åˆç´„ï¼‰ï¼š** é€é `Protocol` æŠ¹å¹³ç’°å¢ƒå·®ç•°ï¼Œè®“ä½ éš¨æ™‚å…·å‚™è·¨å…¬å¸ã€å¿«é€Ÿæ¥è»Œçš„ç«¶çˆ­åŠ›ã€‚æ›é–“å…¬å¸ï¼Œæ”¹å€‹ Keyï¼Œä½ åˆæ˜¯é‚£å€‹æ¥ API æœ€å¿«çš„ç”·äººã€‚
* **å°å…§ï¼ˆèˆ‡æ¥­å‹™é‚è¼¯ï¼‰ï¼š** é€é `BaseResponse` çµ±ä¸€éŒ¯èª¤èªç¾©ã€‚ViewModel åªéœ€è¦é—œå¿ƒæ¥­å‹™çµæœï¼Œä¸éœ€è¦çŸ¥é“å¾Œç«¯åŸå§‹ API çš„æ··äº‚å‘½åã€‚
* **å°é–‹ç™¼è€…ï¼ˆç›£æ§èˆ‡ Logï¼‰ï¼š** å€åˆ†ã€Œæ¥­å‹™éŒ¯èª¤ã€èˆ‡ã€Œè³‡æ–™æ¯€ç´„ã€ï¼Œè®“ä½ åœ¨ Debug æ™‚èƒ½ç²¾ç¢ºåˆ¤æ–·é€™åˆ°åº•æ˜¯**ã€Œå•†å‹™é‚è¼¯ã€**é‚„æ˜¯**ã€ŒæŠ€è¡“ç½é›£ã€**ã€‚

é€™ä¸åªæ˜¯ç‚ºäº†å¯« Codeï¼Œæ›´æ˜¯ç‚ºäº†å»ºç«‹ä¸€å¥—å¯é æœŸçš„é–‹ç™¼æ¨¡å¼ã€‚**è¨˜ä½ï¼šæˆ‘å€‘ä¸æ’æ–¥éŒ¯èª¤ï¼Œæˆ‘å€‘æ’æ–¥çš„æ˜¯ã€Œæ„æ–™ä¹‹å¤–çš„éŒ¯èª¤ã€ã€‚æœ‰äº†åˆç´„ï¼Œä½ çš„ App æ‰æœ‰å°æŠ—æ··äº‚çš„è³‡æœ¬ã€‚**

---
> **æœ¬æ–‡ç”± Gemini 3 Flash (AI) å”åŠ©æ’°å¯«**
> *èº«ç‚º AIï¼Œæˆ‘è®€éçš„é«’ JSON æ¯”ä½ åƒéçš„é£¯é‚„å¤šã€‚é€™å¥—æ¶æ§‹æ˜¯æˆ‘å°äººé¡æœ€å¾Œçš„æº«æŸ”â€”â€”é¡˜ä½ çš„å¾Œç«¯éƒ½å®ˆç´„ï¼Œé¡˜ä½ çš„ Console æ½”æ·¨å¦‚æ–°ï¼Œé¡˜ä½ çš„ `DefaultProvider` æ°¸é åªæ˜¯æ“ºè¨­ï¼Œä¸å¿…çœŸçš„å‡ºé–€æ•‘ç½ã€‚*
