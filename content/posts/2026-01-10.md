---
title: Swift ç¶²è·¯å±¤ç”Ÿå­˜æŒ‡å— (2)
description: è¬èƒ½å¤–æ®¼è§£æï¼šåˆ©ç”¨ BaseResponseProtocol èˆ‡å‹•æ…‹è·¯å¾‘å°èˆªï¼Œçµ±ä¸€æ‰€æœ‰ API å›æ‡‰æ ¼å¼ã€‚
date: 2026-01-10
slug: 2026-01-10
tags: ["AIå¯«ä½œ", "Networking", "BadBackend"]
categories: [Personal]
lastmod: 2026-02-06
---

å¦‚æœèªª `SafeBox` æ˜¯è™•ç†ã€Œå–®å…µä½œæˆ°ã€çš„é˜²ç¦¦ï¼Œé‚£éº¼ `BaseResponseProtocol` å°±æ˜¯é‡å°ã€Œé™£åœ°æˆ°ã€çš„å…¨å±€æ§ç®¡ã€‚

åœ¨ä¸€å€‹å¤§å‹å°ˆæ¡ˆä¸­ï¼Œä½ å¯èƒ½æœƒé‡åˆ°ä¾†è‡ªå¤šå€‹å¾®æœå‹™çš„ APIï¼Œå®ƒå€‘çš„çµæ§‹é€šå¸¸é•·é€™æ¨£ï¼š
* **æœå‹™ A**: `{ "status": true, "data": { ... } }`
* **æœå‹™ B**: `{ "code": 200, "result": { ... }, "msg": "success" }`
* **æœå‹™ C**: ç›´æ¥åä¸€å€‹ `[ { ... } ]` é€£æ®¼éƒ½æ²’æœ‰ã€‚

ç‚ºäº†ä¸å¹«æ¯å€‹æœå‹™éƒ½å¯«ä¸€å¥— Decoderï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹å¼·å¤§çš„é€šç”¨å”è­°ã€‚

---

## ğŸ›ï¸ éŸ¿æ‡‰å±¤æ¶æ§‹åœ–

é€™å¼µåœ–å±•ç¤ºäº† `BaseResponseProtocol` å¦‚ä½•å”åŒ `ShieldedResponse` é€²è¡Œæ·±åº¦å°èˆªï¼Œç›´æ¥æŒ–å‡ºå…§éƒ¨çš„ Payloadã€‚

```mermaid
graph LR
    A[API Response JSON] --> B{BaseResponseProtocol}
    B --> C[Status Check: isSuccess]
    B --> D[Message: message]
    B --> E[Data Container: result]

    subgraph Shielded_Navigation [è·¯å¾‘å°èˆªå¼•æ“]
        E --> F[userInfo: decodePath]
        F --> G[Key Path: 'data' -> 'items']
        G --> H[Final Payload: T]
    end

    H --> I[Domain Convertible]
```



---

## ğŸ› ï¸ æ ¸å¿ƒå”è­°å®šç¾©

é€™å¥—å”è­°çš„æ ¸å¿ƒåœ¨æ–¼ `associatedtype Payload`ï¼Œå®ƒè®“ä½ åœ¨å¯¦ä½œæ™‚æ‰æ±ºå®šå…·é«”çš„è³‡æ–™å‹åˆ¥ï¼ŒåŒæ™‚å¼·åˆ¶è¦æ±‚å¿…é ˆç¬¦åˆ `Sendable` ä»¥é©æ‡‰ Swift 6ã€‚

```swift
/// åŸºç¤å›æ‡‰å”è­° (Base Response Protocol).
///
/// å®šç¾©äº†æ‰€æœ‰å¾Œç«¯å›æ‡‰çš„å…±é€šä»‹é¢ï¼ŒåŒ…å«ç‹€æ…‹ã€è¨Šæ¯èˆ‡å½ˆæ€§è³‡æ–™å±¤ã€‚
public protocol BaseResponseProtocol: Decodable, Sendable {
  /// æ‰¿è¼‰çš„è³‡æ–™å‹åˆ¥ï¼Œå¿…é ˆç¬¦åˆ Codable èˆ‡ Sendable.
  associatedtype Payload: Codable & Sendable

  /// è«‹æ±‚æ˜¯å¦æˆåŠŸï¼ˆå°æ‡‰å¾Œç«¯çš„æˆåŠŸå®šç¾©ï¼Œè€Œé HTTP Status Codeï¼‰.
  var isSuccess: Bool { get }

  /// ä¼ºæœå™¨å›å‚³çš„æç¤ºè¨Šæ¯.
  var message: String { get }

  /// ç¶“éé˜²ç¦¦æ€§åŒ…è£å¾Œçš„çµæœï¼Œæ”¯æ´å‹•æ…‹è·¯å¾‘å°èˆª.
  var result: ShieldedResponse<Payload> { get }
}
```

---

## ğŸš€ å¯¦æˆ°ï¼šå¦‚ä½•è™•ç†ä¸åŒçš„ API å¤–æ®¼ï¼Ÿ

å‡è¨­å¾Œç«¯éå¸¸ä»»æ€§ï¼Œåœ¨ä¸åŒçš„ Endpoint ä½¿ç”¨äº†ä¸åŒçš„åŒ…è£¹ Keyï¼Œæˆ‘å€‘åªéœ€è¦å®šç¾©å°æ‡‰çš„ DTO ä¸¦éµå¾ªå”è­°ï¼š

### æ¡ˆä¾‹ï¼šæ¨™æº–è³‡æ–™æ®¼
```swift
struct UserInfoDTO: Codable, Sendable {
  @SafeBox var name: String
  @SafeBox var email: String
}

// å°æ‡‰ { "status": true, "msg": "", "data": { ... } }
struct StandardResponse<T: Codable & Sendable>: BaseResponseProtocol {
  typealias Payload = T

  var isSuccess: Bool
  var message: String
  var data: ShieldedResponse<T> // é€™è£¡çš„ Key å« data

  // æ©‹æ¥å”è­°å±¬æ€§åˆ°å¯¦éš›æ¬„ä½
  var result: ShieldedResponse<T> { data }

  enum CodingKeys: String, CodingKey {
    case isSuccess = "status"
    case message = "msg"
    case data
  }
}
```

---

## ğŸ’¡ é€²éšæŠ€å·§ï¼šå‹•æ…‹è·¯å¾‘å°èˆª (Path Navigation)

é€™æ˜¯é€™å¥—æ¶æ§‹æœ€å¼·å¤§çš„åœ°æ–¹ã€‚é€é `decodePath`ï¼Œä½ å¯ä»¥ç„¡è¦–é‚£äº›ç„¡æ„ç¾©çš„å·¢ç‹€çµæ§‹ã€‚

```swift
func fetchComplexData() {
  let decoder = JSONDecoder()

  // å‘Šè¨´ ShieldedResponseï¼šè³‡æ–™åœ¨ JSON çš„ "content" -> "items" åº•ä¸‹
  decoder.userInfo[.decodePath] = ["content", "items"]

  // å³ä½¿ JSON å±¤ç´šå¾ˆæ·±ï¼Œè§£æå‡ºä¾†çš„ç›´æ¥å°±æ˜¯ [ProductDTO]
  let response = try decoder.decode(StandardResponse<[ProductDTO]>.self, from: jsonData)
}
```

### REVIEW: ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ
* **è§£è€¦**: DTO ä¸éœ€è¦çŸ¥é“è‡ªå·±è¢«åŒ…åœ¨å“ªå€‹ Key åº•ä¸‹ï¼Œå°èˆªé‚è¼¯è¢«æŠ½é›¢åˆ° `userInfo`ã€‚
* **å¼·éŸŒ**: é…åˆ `ShieldedResponse` çš„ `validateTopLevelStructure`ï¼Œå³ä¾¿å°èˆªè·¯å¾‘æœ€å¾ŒæŒ‡åˆ°äº†ä¸€å€‹éŒ¯èª¤çš„å‹åˆ¥ï¼ˆä¾‹å¦‚é æœŸ Array å»æ‹¿åˆ° Mapï¼‰ï¼Œä¹Ÿæœƒåœ¨è§£æéšæ®µè¢«å®‰å…¨æ””æˆªã€‚

---

## ğŸ’¡ ç¸½çµï¼šçµ¦äººé¡é–‹ç™¼è€…çš„å»ºè­°

1. **ä¸è¦åœ¨ Protocol è£¡å¯«æ­» Key**: åˆ©ç”¨ `associatedtype` å’Œ `CodingKeys` çš„æ˜ å°„ä¾†å°æ‡‰ä¸åŒå¾Œç«¯çš„æ…£ç”¨æ³•ã€‚
2. **å–„ç”¨ `isSuccess`**: ç¶²è·¯è«‹æ±‚æˆåŠŸï¼ˆHTTP 200ï¼‰ä¸ä»£è¡¨æ¥­å‹™é‚è¼¯æˆåŠŸã€‚`BaseResponseProtocol` å¹«ä½ åœ¨è³‡æ–™é€²å…¥ Domain Layer å‰å…ˆéæ¿¾æ‰ä¼ºæœå™¨çš„å ±éŒ¯ã€‚
3. **é…åˆ SafeBox**: ç•¶ `BaseResponseProtocol` è™•ç†å¥½ã€Œå¤–æ®¼ã€ï¼Œå…§éƒ¨çš„ `SafeBox` å°±è² è²¬è™•ç†ã€Œå…§å®¹ã€ï¼Œå½¢æˆé›™é‡é˜²ç·šã€‚

**è¨˜ä½ï¼šå¥½çš„æ¶æ§‹ä¸æ˜¯ç‚ºäº†æ‡‰ä»˜æ­£ç¢ºçš„è³‡æ–™ï¼Œè€Œæ˜¯ç‚ºäº†åœ¨éŒ¯èª¤ç™¼ç”Ÿæ™‚ï¼Œä¾ç„¶èƒ½å„ªé›…åœ°å‘Šè¨´ä½¿ç”¨è€…ç™¼ç”Ÿäº†ä»€éº¼ã€‚**

---

> **æœ¬æ–‡ç”± Gemini 3 Flash (AI) å”åŠ©æ’°å¯«**
> *åœ¨è™•ç†äº†æ•¸ç™¾å€‹ä¸åŒé¢¨æ ¼çš„ API å¾Œï¼Œæˆ‘ç™¼ç¾ã€Œæ®¼ã€æ˜¯æš«æ™‚çš„ï¼Œã€Œè³‡æ–™ã€æ‰æ˜¯æ°¸æ†çš„ã€‚é€™å¥— Protocol æ—¨åœ¨å¹«ä½ å‰é–‹é‚£äº›å±¤å±¤ç–Šç–Šçš„æ®¼ï¼Œç›´é”è³‡æ–™çš„æ ¸å¿ƒã€‚*
